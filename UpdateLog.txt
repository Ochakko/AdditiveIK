AdditiveIK UpdateLog
https://github.com/Ochakko/AdditiveIK




2024/01/11
　BrushParamsプレートメニューのTopPosのテキスト表示更新に関わる不具合を修正
　　フレーム選択変更時にTopPosのGUI表示が更新されていなかった
　モデルのインスタンシング表示に対応
　　ただし非スキンメッシュで１メッシュにつき１マテリアルのモデルに限る
　リグの表示をインスタンシング方式に変更
　　CameraAndIKプレートメニューのRigボタンを押したときに表示されるリグに関する変更
　　アプリ起動の高速化
　　　アプリ起動時にリグを１００個読み込んでいたのが　４個の読み込みになった
　　球、リングX、リングY,リングZそれぞれリグについて24個までの制限. (個数は暫定)
　　



2024/01/09
　Rigの設定(ジョイント右クリック->Rig名->Settingメニューで出る)の回転軸の追加
　　CurrentX, CurrentY, CurrentZ,
　　ParentX, ParentY, ParentZ,
　　GlobalX, GlobalY, GLobalZ,
　　NodeX, NodeY, NodeZ
　　上記９種類に増やした
　　足の付け根UpperLegの前後回転軸はParentYとした
　　Testフォルダのrigファイルを更新
　　古い設定はCurrent*として扱う
　マニピュレータの計算の修正
　　Hipsの特別扱いを止めて　Hips自身の回転を考慮するようにした
　　Rigの足の付け根(UpperLeg)の回転が　体全体の回転後も設定どおりに曲がるようになった
　右ペインのウインドウのスクロールバードラッグのキャプチャとリリースに関して修正
　　スクロールバードラッグ中に　画面外でマウスを離した場合に　挙動がおかしくなる不具合が直った
　モデルを追加読み込みするとモーションスピードがスライダーの値と異なってしまう不具合を修正
　　DispAndLimitsプレートメニューのSpeedスライダーの設定どおりになった


2024/01/08
　マルチUVの使い方を修正
　　Albedo, Normal, Metal丸ごと一緒にUVSet0とUVSet1を切り替えるように.
　　DispAndLimitsプレートメニューに UVSetコンボボックスを追加
　LaterTransparent設定ウインドウに　Albedoテクスチャ名がエントリーされていなかった不具合修正
　　AlbedoでもNormalでもMetalでもないテクスチャ名だけがエントリーされていた不具合だった


2024/01/07
　２個までのマルチUVに対応
　　ただし用途は限定　１つ目のUVはalbedoテクスチャ　２つ目のUVはノーマルマップとメタルマップ用
　　マルチUV対応で　ノーマルマップの模様ががカメラ距離で伸び縮みする不具合解消
　１メッシュに複数マテリアルがある場合に　面のマテリアル番号設定に問題があったのを修正
　テクスチャアドレッシングモードの読み込みと表示への適用と保存
　　サンプラーステートにも適用
　テクスチャ命名規則を少し修正(_Baseが加わった)
　　Albedoまたはalbedoまたは_Baseが名前にテクスチャをAlbedoMap
　　Normalまたはnormalが名前につくテクスチャをNormalMap
　　Metalまたはmetalが名前につくテクスチャをMetalMap
　DirectXTexをDec2023に差し替え


2024/01/05
　DirectXTK12をJun2023からDec2023に差し替え.
　　MiniEngine直下に置いていたd3dx12.hも更新
　　d3dx12.hのwarningが出なくなった.
　　遠くのテクスチャの画質が良くなったような気がする?

　既知の問題と対処法
　　問題004
　　　ジョイントの方向(いわゆる初期姿勢)として　X180, Y90, Z0が設定されているfbxの書き出しが変質する不具合がある。
　　　書き出し時だけ問題が出る。読込とリターゲットはうまくいく。
　　　X180, Y90, Z0の初期姿勢が設定されているモーションに対しては
　　　読み込み後に普通の軸のモデルにリターゲットしてから保存してください。





2024/01/04
　AdditiveIK 1.0.0.2 release
　　1.0.0.1からの変更点
　　　不具合修正
　　　　ボタンを押してもShader設定ダイアログが出ないことがある不具合修正
　　　　Rigの設定が意図せず重複して片方を選べなくなる不具合修正
　　　　シャドウの向きを修正
　　　　マニピュレータの軸(計算と表示共に)がparent側に１階層分ずれていたのを修正
　　　　　体全体を９０度回転した場合に足の付け根のRigの軸が設定と異なる現象を追いかけていたら発覚
　　　　　IK操作、Rig操作とRigの設定に影響
　　　　　軸の種類はDispAndLimitプレートメニューのAxisKindコンボボックスで
　　　　　Current, Parent, Global, Nodematから選択可能. 
　　　　　今回の修正をする前の振る舞い再現はAxisKindでParentを選択すれば可能(Rigの設定が昔のままの場合).
　　　　　IK操作の軸が操作中にブレないことを再確認
　　　LOD機能追加　ProjAndLODプレートメニュー追加
　　　MipMap対応
　　　　テクスチャ読み込み時に全レベルMipMapを作成して転送
　　　　サンプリングステートでMipを有効に
　　　VRoid特有のジョイント名がある場合には　シェーダー設定がAUTOのときにNOLIGHTを適用してトゥーン風に表示
　　　ブラシ設定のRepeatsのスライダーの最大値を100に.(変える前は10)
　　　起動時の初期値を変更
　　　　HighRpmを最初から有効に.
　　　　4Kモード時には　ZprepassCullingを最初から有効に.
　　　ツールショートカットボタンのModelWorldMat設定ウインドウにカメラ位置、カメラ注視点にモデルを置くボタンを追加
　　　シャドウのbiasスライダーの最小値を0に.(変更前は0.001)
　　　Testフォルダにモデル追加　
　　　　Test/3_Winter2_1
　　　トラブルシューティング追加
　　　　Documsnts/TroubleShooting/AboutSettingsOfLOD.docx
　　　　Documsnts/TroubleShooting/AboutSettingsOfShader.docx
　　　　Documsnts/TroubleShooting/AboutSettingsOfShadow.docx
　　　　Documsnts/TroubleShooting/DarkNoiseOn3DScreen.docx
　　　　Documsnts/TroubleShooting/HowToImproveJaggedImageQuality.docx
　　　　Documsnts/TroubleShooting/Partially180DegreesDifferent.docx




2024/01/02
　Testフォルダにモデル追加
　　Test/3_Winter2_1
　　VRoid製のモデルです  ３万数千ポリゴンです
　VRoid特有のジョイント名がある場合には　シェーダー設定がAUTOのときにNOLIGHTを適用してトゥーン風に表示
　ブラシ設定のRepeatsのスライダーの最大値を100に.(変える前は10)
　トラブルシューティング追加
　　Documsnts/TroubleShooting/AboutSettingsOfLOD.docx
　　Documsnts/TroubleShooting/AboutSettingsOfShader.docx
　　Documsnts/TroubleShooting/AboutSettingsOfShadow.docx
　　Documsnts/TroubleShooting/DarkNoiseOn3DScreen.docx




2024/01/01
　MipMapに対応
　　とりあえず対応しました
　　何回もテストをしましたが正しく出来ている確信はまだ無いです
　　Stdシェーダーはきれいになったと思います　しかし、PBRの遠くのざらざらしているノーマルマップはまだ縞模様になったりしています




2023/12/30
 前述問題002に対応
　　ProjAndLODプレートメニュー追加
　　プロジェクションとLODのパラメータを設定可能に
　　プロジェクションとLODの設定はプロジェクトファイル(*.cha)保存時に保存、プロジェクトファイル読み込み時に読み込み
　　効果について
　　　少し試してみて感想
　　　LODで高速化の効果を出すのは結構大変(データ作成やシーンとしての最適化が難しい)
　　　それでもLOD0, LOD1のクリッピング距離を最低値に近づけると多少効果はあった
　　　プロジェクションパラメータを絞り込む方が目にみえて効果がある
　　　例えばFov(視野角)をシーンが欠けない程度に小さくする
　　　例えばnearを出来るだけ大きく、farを出来るだけ小さく(near < farの範囲で)
　　　####!!!!  4KモードにおいてはDispAndLimitsメニューのZPrePassCullingがとても効果的  !!!!####
　　　DispAndLimitsメニューでDispBoneMarkをオフにしても効果有
　　　DispAndLimitsメニューでHighRpmにしてからUpdateThreadsスライダーを調整
　　　上記パラメータ設定にての合わせ技にて
　　　当方の環境(古めの８コアPC+RTX2080)では４Kモード(ウインドウ大モード)でアセットシーンがどれも33fps程になった
　　　最近のゲーミングPCでなら60fpsを越えるものと思われる　(とにかく重い処理をしているのだからしょうがない)
　12/30 その２
　　ProjAndLODメニューのFOV(視野角)の設定がカメラの設定に適用されていなかったのを修正
　　(クリッピングにだけ反映されていた)
　　FOVは焦点距離に関係する. 小さくするほど描画は速くなるが絵の奥行き感が減る.
　　視野内判定ChkInViewを最適化して少し高速化.
　12/30 その３
　　起動時の初期値を変更
　　　HighRpmを最初から有効に.
　　　4Kモード時には　ZprepassCullingを最初から有効に.
　　ProjAndLODメニューのFOV(視野角)のスライダーの最大値を179degreeに.

　　前述の既知の問題001, 002, 003について対応済とする
　　　問題001
　　　　 ShaderParamsDlgProcの問題だった。WndProcを回すべきところで回っていなかったのを修正
　　　　解決
　　　問題002
　　　　直しながら症状をみたが　計算による遅さというよりも描画そのものの重さのようだ
　　　　思いついた対策はしたが　とりあえずここまでとする
　　　　当方のビデオカードはRTX2080で今でも速い部類のようだが　現行のRTX4070は２倍速いらしい
　　　　現状でも４Kモードでもなんとか30fps出るので　開発環境についてはゆっくり考える
　　　問題003
　　　　Rig設定ウインドウを出すときに　右ペインウインドウ全てを閉じるようにして解決
　　
　　



2023/12/27 既知の問題と対処法について
　問題001(2023/12/30解決)
　　カメラ操作用スプライトをマウスでドラッグし、
　　右ペインのメニューボタン上でマウスを離すと
　　右ペインウインドウの設定ボタン類を押しても無反応になる
　対処方
　　右ペインのメニューボタン上ではマウスを離さない
　プログラム修正予定　：　有

　問題002(2023/12/30解決)
　　アセットの表示が重すぎる
　原因
　　表示詳細度切り替え用のLODオブジェクト全てを
　　重ねて表示している状態
　対処法
　　DispGroupメニューで
　　非表示にしたいオブジェクトにグループ番号を付けてから
　　非表示ボタンを押す
　プログラム修正予定　：　有

　問題003(2023/12/30解決)
　　Rigの設定でRigの名前が既存Rigの名前と同じになり
　　選択不能になる
　原因
　　Rigの設定ウインドウが開いている状態で
　　他のRigの設定ウインドウが開いてしまい
　　保存時に同じ内容になる
　対処法
　　右ペインのXボタンで
　　Rig毎に手動でウインドウを閉じてから
　　次のRigウインドウを開いて設定する
　プログラム修正予定　：　有




2023/12/24
AdditiveIK 1.0.0.1 release




2023/12/23
AdditiveIK 1.0.0.1 RC6(リリース候補6)
　１段目と２段目のプレートメニュークリックで出る右ペインウインドウが重なって表示されていた不具合修正
　iniファイルのファイル名修正
　Testフォルダのモデルデータのまゆ毛透過をLaterTransparentメニューで設定
　TestフォルダのSpring1の髪の毛がまだ少し肩に食い込んでいたので調整
　ファイルオープンダイアログのTestフォルダのパスが古かったのを修正




2023/12/22
AdditiveIK 1.0.0.1 RC5(リリース候補5)
　ShaderTypeウインドウ、ShaderTypeParamsダイアログの挙動修正

AdditiveIK 1.0.0.1 RC4(リリース候補4)
　ShaderTypeダイアログがスクロール出来ていなかったのを修正.
　ShaderTypeParamsダイアログにEnableEmissionチェックボックスを追加.
　　色の計算にEmissionを含める場合にはEnableEmissionにチェックを入れる.
　　EnableEmissionの初期値はfalse.
　マニピュレータの色調整.
  fps数字表示位置を少し下に移動.



2023/12/21
AdditiveIK 1.0.0.1 RC3(リリース候補3)
　デバッグビルドで　レンダー時にバリアの警告が出ていた問題について修正
　README.mdに使い方を追記




2023/12/19
AdditiveIK 1.0.0.1 RC2(リリース候補2)
　ダイアログの最初の出現位置をセンターにしつつ　操作中に元の位置に戻らないように.
　Rigボタンを押したときのRigの表示. Rigは球、RingX, RingY, RingZの４種類あり　それぞれ24個までの制限に.
　準備中のウインドウ領域が白くならないように.



2023/12/18
AdditiveIK 1.0.0.1 RC1(リリース候補1)
　Shadowパラメータを８スロット分設定可能に.
　Shaderのライトスケール最大値を5.0に.
　ダイアログのセンターに配置し直す機能はデスクトップの(0, 0)に表示しようとした場合にだけ.
　プレビュー中はプレートメニューを非表示に.
　Documents/TroubleShooting追加

　機能していない設定画面もありますが　年内に一度リリースしておきたいので　いったんここで区切ります




2023/12/17
ピクセルシェーダ内の計算が有効なライトの個数分だけループするように.
HDRP対応
　ライトスライダーの上限値を3.0に. Shaderのライト倍率の上限値も3.0に.
HDRP Bloomエフェクト追加
　色の値が1.0を越えた部分にブルームがかかり　周りに淡く広がりを持つ表示になります
　シェーダーをStdにして　ライトを1.0以上にすると　効果が掛かりやすい
README.mdのスクリーンショット更新



2023/12/15
Shadowプレートメニュー追加
　設定はアプリ終了時にtempフォルダに保存し　起動時に自動読込
DispAndLimitsメニューに　Free fpsチェックボックス追加
　FreeFpsをオンにするとfpsは大きくなりますが　
　可変周波数対応モニタ以外でオンにすると　ティアリングが起こることがあります
Shadowメニューに　EnableShadowチェックボックス追加
　シャドウ表示をオンオフ出来ます



2023/12/14
デプスシャドウ機能を追加
　テストとしてカメラから選択モデルのHipsジョイントの方向へシャドウ用のライトを向けています
プロジェクト保存時に　Shaderメニューのsmoothcoefも保存
デプスシャドウのスクリーンショットをREADME.mdに追加
デプスシャドウリファクタリング　必要不要を試行錯誤して判断しメモリの不要な多重化をやめた




2023/12/10
MetalSmoothMapの　rにmetalcoefを　aにsmoothcoefを掛けて調整
　ShaderメニューのMetalCoefスライダーとSmoothCoefスライダーで設定
　手持ちのアセットで試したところ　smoothCoefの方が影響が大きい　smoothが大きいほど白く小さいほど拡散色が出る
ShaderTypeParamsDlgでの設定値をShaderTypeWndにも反映
ツールボタンショートカットアイコンのMaterialRate設定の内DiffuseRateとSpecularRateをシェーダに反映
　モデル単位でDiffuseとSpecularに倍率を掛けることが可能
　AUTO, PBR, STD, NOLIGHTに対して効果有



2023/12/09
ZPrepassクリッピングをDispAndLimitsメニューのオプションに.
　シーンによって効果がある場合と　マイナス効果になる場合があったので必要に応じて.
PBR時NormalMapが無い場合には　GetNormalMap()はblackMapを返すように.
　PBRにはnormalMapは必須という前提だがそれが無い場合の対応.
　whiteMapを返すと法線の向きが変わってしまうのでblackMapを返すことに.
シェーダ定数の転送は　シェーダファイル毎描画フレーム毎に１回にしてみた
　fpsに変わりはなかった


2023/12/08
Shaderプレートメニュー追加
　Shaderの設定をマテリアルごとに設定する仕様に変更.
　Shaderメニューのウインドウの見出し行のボタンで全マテリアルに対しての設定も可能.
　マテリアルごとにシェーダータイプ、メタル係数、ライトスケールx8個の設定が可能.
　プロジェクトファイル保存時に他のファイルと共に*.stfファイルとして保存、プロジェクト読み込み時に自動読込
ライトパラメータのシェーダへの転送が十分ではなかったのを修正
デフォルトのメタル係数を0.7から0.25へ変更
アプリのアイコンを変更(再起動しないと変更が反映されないこともあるようです)
README.mdのスクリーンショットを更新


2023/12/06
Lightプレートメニューの設定をシェーダーに反映.
ライトの数は８個まで.
矢印キーによるジョイント階層ウインドウの選択移動機能を復活


2023/12/05
ZPrepassレンダーを導入. カラー描画前にZバッファを構築する方法. 画面手前に遮蔽物があるほど描画が高速化.
ZPrepassレンダー時には半透明メッシュはZバッファに書き込まないように.
ZPrepassは4KTVモードでは遮蔽面積が大きいため効果があるが2KTVモードではZ書き込みコストの方が効果よりも大きい
ZPrepassは4KTVモードのときだけ有効にした.
シェーダーとパイプラインについてリファクタリングし　DispParamsプレートメニューのShaderTypeでAuto, PBR, STD, NOLIGHTを切り替え可能に.
法線マップを設定していないモデルに対してPBRを選択すると　法線が０となり黒い表示になることに注意
ShaderTypeでAUTOを選んだ場合のシェーダー設定は以下
　スキンメッシュについては　[Albedo無しまたはNormal有またはMetal有]->PBR,　[Albedoだけ有またはテクスチャ１つも無し]->NOLIGHT
　非スキンメッシュについては　[Albedo無しまたはNormal有またはMetal有]->PBR,　[Albedoだけ有またはテクスチャ１つも無し]->STD
スキンメッシュと非スキンメッシュそれぞれのShaderTypeに対して　不透明、半透明、半透明常時上書きの設定があり自動設定



2023/12/04
PBR対応開始
//############
// UnityAssetをUnityでfbxエクスポートする場合、全てのマテリアルのシェーダーをStandardにするとfbxにテクスチャ名が出力される
// それ用のEditorスクリプトをみつけてきて使っています
//############
テクスチャ無しの場合とノーマルマップまたはメタルマップがある場合にPBR、それ以外の場合にStandardで描画
プロジェクト保存時　fbxのPBR用テクスチャ(albedo, normal, metal)も保存
描画はモデルを横断してDispGroupNo順に行っている　DispGroupNo == 1以外の描画時には強制的に半透明描画
//############
//pMesh->GetNode()に対してGetMaterial(i)を呼んでマテリアル情報を取得すると不正な情報が入っていた
//マテリアル名に本来のマテリアル情報とは異なるtypo_2という名前, テクスチャにtype_2.pngが入っていた
//pMesh->GetNode()はマテリアル情報のためには使わないことに.
//############


2023/12/02
もう少し前準備として　不透明半透明のパイプライン切り替え　ボーンマトリックス更新最適化
プロジェクト保存時にfbxのテクスチャが保存されなくなっていたのを修正
Testフォルダをgit add. モデルはVRoid.


2023/12/01
描画を綺麗にする前に目立った不具合に対応
MaterialBankをモデル(fbx, mqo)ごとに持つように修正
マテリアル番号の重複によるマテリアルずれ解消
マニピュレータ不具合解消
ボーンマトリックスの転送を毎回の描画のマテリアルごとに１回に絞り少しだけ高速化


2023/11/30
MaterialBankを追加することにより大きい背景fbxも読み込めるようになった
ただし１つのfbxにつきボーン数は1000個までという制限付き
デスクリプタヒープの数を減らすことにより背景を読めるようになったのだが
マテリアルごとに全部のボーン姿勢を転送しなくてはならなくなり重くなってしまった
マニピュレータの常時上書き設定は一時的に効かなくしている
明日は背景を綺麗に表示するために修正する予定(予定)


2023/11/29
DescriptorHeapに関するリファクタリング
大きい背景読み込み時に4038個目のDescriptorHeap作成でE_OUTOFMEMORYになる症状は変わらず
背景の描画をきれいにしたかったのだが　どうするか試しながら考える


2023/11/28
プレートメニューを２段構成に.
１段目は常時固定メニュー. ２段目はカエルボタンで変化.
１段目のメニューに対するGUIは右ペインウインドウに表示.
１段目と２段目のメニューに関わる作業を行き来するに便利なようにしたつもり.
１段目のCameraAndIKは他のメニューとは独立してトグル.
１段目のCameraAndIK以外は１段目の他のメニューをオンにしたときにオフになる.
２段目のプレートをオンにすると１段目のCameraAndIK以外はオフになる.


2023/11/27
レンダリングエンジンにフォント表示を追加
ツールチップを表示
線だけで構成されたメッシュの表示にも対応
地面データとして線で出来た格子と軸を表示


2023/11/26
選択ジョイントの位置にマニピュレータを表示
マウスホバーでマニピュレータをハイライト表示
物理プレイボタンと物理ベイクボタンをプレイヤーボタンに追加
レンダリングエンジンにスプライト描画処理を追加.
ジョイント位置にスプライト表示. マークは白、セレクトツリーは赤.


2023/11/25
魔導書のSpriteクラスを拡張してインスタンシングに対応させたInstancedSpriteクラス新規
同じスプライトを違う場所違う大きさで描画可能
InstancedSpriteでfpsとアンドゥバッファ位置を表示
GUIに関しては現在のウインドウに重ねて表示できるものがみつからないため　右ペインに通常通り表示する予定に変更
なるべくクリック回数が増えないように段階を追って改善していくつもり
関節部ドラッグでとりあえずAdditiveIK出来るようにしました.　ブラシパラメータ設定などはGUIを準備してから.


2023/11/23
デバッグビルドで実行終了時に表示されるメモリリークが気になってリファクタリング
メモリリークは無くなった?


2023/11/22
スプライトGUIを魔導書のSpriteクラスで.
プロジェクトやfbxを読み込むとプレートメニューが出ます.
下の方のカエルボタンでメニュー変更. 上の方のカエルボタンでショートカットボタンを変更.
Documents/ModifyAboutGrimoireSpriteClass.docx追加
Documents/CoexistenceOfConventionalMaterialsAndPBR.docx追加
カメラ操作を有効に. CameraAndIKプレートをクリックしてボタンを出し、３つのカメラボタンドラッグでカメラ操作.
モーションのプレビューが出来るようになりました.
モーション付きモデルを読み込み後にタイムラインのプレイマークのボタンでプレビュー.


2023/11/20
Texture設定の無いメッシュ描画時には白いalbedoテクスチャを使用
マテリアルのdiffuse色のテクスチャを作成してalbedoテクスチャと乗算して描画
このようにすることで　古いマテリアル形式と将来対応するPBRとが共存出来る可能性
4KTV接続時にアプリウインドウ大と小を選べるように


2023/11/19
Texture表示が可能になった
透過テクスチャを有効に
透過テクスチャ遅延描画順機能(LaterTransparent)を有効に


2023/11/18
DirectX12による表示開始
とりあえず　白いシルエットでモデルを表示
VRoidモデルはシルエット表示できた
仕組みとしてはテクスチャに対応しているのだが　シェーダーでテクスチャを使うと何も表示されなかった
4000個くらいメッシュがあるfbxを読み込むとアウトオブメモリエラーだった
次回はテクスチャを表示したい


2023_11_14
もの凄い作り直しをしようとしていましたが　考えた結果　表示とUIの挿げ替えをすることに
MameBake3Dの表示をPBRとカスケードシャドウに対応させて　UIはimguiで表示するための作業をしていく 予定
とりあえずDX12用のファイルを足して　DX11をコメントアウト　してビルドして起動可能に
まだモデルを表示できない状態


2023_11_12
まずはAdditiveIKのレポジトリを作成
MameBake3D + HLSシェーダーの魔導書(DirectX12)の描画　+ DirectX12の魔導書のDX12文法 + bullet physicsからスタートする予定
ビルドは出来ますがまだ動きません　これからです.








